<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="VisuaLex - Piattaforma avanzata per lo studio giuridico.">
  <title>VisuaLex Workspace</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Google Fonts (Inter for UI, Merryweather for reading) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
  <!-- CKEditor -->
  <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/style.css?v=2.0">
</head>
<body>

  <div class="app-container">
    
    <!-- Sidebar Navigation -->
    <aside class="sidebar d-flex flex-column flex-shrink-0 p-3 bg-body-tertiary" id="sidebar">
      <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none logo-area">
        <i class="bi bi-book-half fs-2 me-2 text-primary"></i>
        <span class="fs-4 fw-bold tracking-tight">VisuaLex</span>
      </a>
      <hr>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-view="search-view">
            <i class="bi bi-search me-2"></i>
            Ricerca
          </a>
        </li>
        <li>
          <a href="#" class="nav-link link-body-emphasis" data-view="workspace-view">
            <i class="bi bi-layout-text-window-reverse me-2"></i>
            Workspace
          </a>
        </li>
        <li>
          <a href="#" class="nav-link link-body-emphasis" data-view="history-view">
            <i class="bi bi-clock-history me-2"></i>
            Cronologia
          </a>
        </li>
        <li>
          <a href="#" class="nav-link link-body-emphasis" data-view="bookmarks-view">
            <i class="bi bi-bookmark-star me-2"></i>
            Segnalibri
          </a>
        </li>
      </ul>
      <hr>
      <div class="dropdown">
        <a href="#" class="d-flex align-items-center link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <div class="avatar-placeholder rounded-circle me-2"><i class="bi bi-person-fill"></i></div>
          <strong>Utente</strong>
        </a>
        <ul class="dropdown-menu text-small shadow">
          <li><a class="dropdown-item" href="#">Impostazioni</a></li>
          <li><a class="dropdown-item" href="#">Profilo</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><button class="dropdown-item" id="theme-toggle"><i class="bi bi-moon-stars me-2"></i>Tema Scuro</button></li>
          <li><a class="dropdown-item" href="#">Esci</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      
      <!-- Top Bar (Mobile Toggle & Info) -->
      <header class="top-bar d-flex align-items-center justify-content-between p-3 mb-4 border-bottom bg-body">
        <button class="btn btn-link d-md-none" id="sidebar-toggle"><i class="bi bi-list fs-3"></i></button>
        <div class="breadcrumbs text-muted small">
          <span id="current-view-title">Ricerca Normativa</span>
        </div>
        <div class="actions">
            <button class="btn btn-outline-secondary btn-sm" id="focus-mode-btn" title="ModalitÃ  Focus"><i class="bi bi-fullscreen"></i></button>
        </div>
      </header>

      <div class="container-fluid px-4">
        
        <!-- Error Container -->
        <div id="error-container" class="alert alert-danger shake mb-4" style="display: none;" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i><span class="error-text"></span>
        </div>

        <!-- VIEWS (Managed via JS) -->
        
        <!-- VIEW: SEARCH -->
        <div id="search-view" class="view-section">
          <div class="row g-4">
            <!-- Search Form Card -->
            <div class="col-lg-4 col-xxl-3">
              <div class="card shadow-sm border-0 h-100 sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                  <h5 class="card-title fw-bold mb-0"><i class="bi bi-sliders me-2"></i>Parametri</h5>
                </div>
                <div class="card-body px-4 pb-4">
                  <form id="scrape-form" class="needs-validation d-flex flex-column gap-3" novalidate>
                    
                    <div class="form-group">
                      <label for="act_type" class="form-label small fw-semibold text-uppercase text-muted">Tipo atto</label>
                      <select id="act_type" name="act_type" class="form-select form-select-sm" required>
                        <option value="">Seleziona...</option>
                        <optgroup label="Fonti Primarie">
                            <option value="costituzione">Costituzione</option>
                            <option value="legge">Legge</option>
                            <option value="decreto legge">Decreto Legge</option>
                            <option value="decreto legislativo">Decreto Legislativo</option>
                        </optgroup>
                        <optgroup label="Codici">
                            <option value="codice civile">Codice Civile</option>
                            <option value="codice penale">Codice Penale</option>
                            <option value="codice di procedura civile">Proc. Civile</option>
                            <option value="codice di procedura penale">Proc. Penale</option>
                        </optgroup>
                         <optgroup label="Unione Europea">
                            <option value="Regolamento UE">Regolamento UE</option>
                            <option value="Direttiva UE">Direttiva UE</option>
                            <option value="TUE">TUE</option>
                            <option value="TFUE">TFUE</option>
                            <option value="CDFUE">CDFUE</option>
                        </optgroup>
                        <!-- Altri codici -->
                         <option value="codice della navigazione">Codice della Navigazione</option>
                         <option value="codice della strada">Codice della Strada</option>
                         <option value="codice del processo amministrativo">Codice Proc. Amm.</option>
                         <option value="codice della crisi d'impresa e dell'insolvenza">Codice Crisi d'Impresa</option> 
                         <!-- ... altri options originali ... -->
                      </select>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label for="act_number" class="form-label small fw-semibold text-uppercase text-muted">Numero</label>
                            <input type="text" id="act_number" name="act_number" class="form-control form-control-sm" placeholder="n.">
                        </div>
                        <div class="col-6">
                            <label for="date" class="form-label small fw-semibold text-uppercase text-muted">Data</label>
                            <input type="text" id="date" name="date" class="form-control form-control-sm" placeholder="aaaa">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="article" class="form-label small fw-semibold text-uppercase text-muted">Articolo</label>
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary decrement"><i class="bi bi-dash"></i></button>
                            <input type="text" id="article" name="article" value="1" class="form-control text-center fw-bold">
                            <button type="button" class="btn btn-outline-secondary increment"><i class="bi bi-plus"></i></button>
                        </div>
                    </div>

                    <div class="p-3 bg-body-secondary rounded-3 mt-2">
                        <label class="form-label small fw-semibold text-uppercase text-muted mb-2">Versione</label>
                        <div class="d-flex gap-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="vigente" name="version" value="vigente" checked>
                                <label class="form-check-label small" for="vigente">Vigente</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="originale" name="version" value="originale">
                                <label class="form-check-label small" for="originale">Originale</label>
                            </div>
                        </div>
                        <input type="date" id="version_date" name="version_date" class="form-control form-control-sm" disabled>
                    </div>

                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="show_brocardi_info" name="show_brocardi_info">
                        <label class="form-check-label small" for="show_brocardi_info">Includi Brocardi & Ratio</label>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-primary shadow-sm btn-lg-custom">
                            <i class="bi bi-lightning-charge-fill me-2"></i>Estrai
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" id="reset-button" class="btn btn-light flex-grow-1 btn-sm" title="Reset form"><i class="bi bi-arrow-counterclockwise"></i></button>
                            <button type="button" id="clear-search-fields" class="btn btn-light flex-grow-1 btn-sm" title="Pulisci campi"><i class="bi bi-eraser"></i></button>
                        </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Results Area -->
            <div class="col-lg-8 col-xxl-9">
                <!-- Loading State -->
                <div id="loading" class="text-center py-5" style="display: none;">
                    <div class="spinner-grow text-primary mb-3" role="status"></div>
                    <p class="text-muted animate-pulse">Elaborazione dei dati giuridici in corso...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="text-center py-5 text-muted">
                    <i class="bi bi-search fs-1 opacity-25"></i>
                    <p class="mt-3">Seleziona i parametri e avvia la ricerca per visualizzare le norme.</p>
                </div>

                <!-- Results Container -->
                <div id="norme-container" class="results-stack">
                    <!-- Norm cards will be injected here -->
                </div>
            </div>
          </div>
        </div>

        <!-- VIEW: HISTORY (Hidden by default) -->
        <div id="history-view" class="view-section d-none">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-body border-bottom d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold">Cronologia Ricerche</h5>
                    <button id="reset-history" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash me-2"></i>Svuota</button>
                </div>
                <div class="card-body">
                    <input type="text" id="history-search" class="form-control mb-3" placeholder="Filtra cronologia...">
                    <ul id="history-list" class="list-group list-group-flush rounded-3">
                        <!-- History items -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- VIEW: WORKSPACE (Placeholder) -->
        <div id="workspace-view" class="view-section d-none">
            <div class="text-center py-5">
                <i class="bi bi-cone-striped fs-1 text-warning"></i>
                <h3 class="mt-3">Workspace in costruzione</h3>
                <p>Qui potrai organizzare e confrontare le norme salvate.</p>
            </div>
        </div>

      </div>
    </main>
  </div>

  <!-- TEMPLATES -->
  
  <!-- Template: Norm Card Wrapper -->
  <template id="norm-collapsible-template">
    <div class="card border-0 shadow-sm mb-4 norm-card animate-slide-up">
      <div class="card-header bg-body border-bottom py-3 d-flex justify-content-between align-items-center cursor-pointer" data-bs-toggle="collapse" data-bs-target="">
        <div class="d-flex align-items-center gap-3">
            <div class="icon-box bg-primary-subtle text-primary rounded-circle p-2">
                <i class="bi bi-book"></i>
            </div>
            <div>
                <h5 class="norm-title mb-0 fw-bold text-body-emphasis"></h5>
                <small class="text-muted norm-subtitle">Atto normativo</small>
            </div>
        </div>
        <i class="bi bi-chevron-down text-muted transition-transform"></i>
      </div>
      <div class="collapse show norm-content" id="">
        <div class="card-body p-0">
            <div class="tabs-wrapper bg-body-secondary border-bottom px-3 pt-3">
                <ul class="nav nav-tabs border-0 gap-2 norm-tabs" role="tablist"></ul>
            </div>
            <div class="tab-content norm-tab-content p-4"></div>
        </div>
      </div>
    </div>
  </template>

  <!-- Template: Article Tab -->
  <template id="article-tab-template">
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2 border-0 rounded-top-3 bg-body text-muted" data-bs-toggle="tab" type="button" role="tab">
        <span class="tab-label">Art. X</span>
        <div class="tab-actions ms-2 opacity-50 hover-opacity-100">
            <i class="bi bi-pin-angle pin-button" title="Pin"></i>
            <i class="bi bi-x-lg close-button ms-1" title="Chiudi"></i>
        </div>
      </button>
    </li>
  </template>

  <!-- Template: Article Content -->
  <template id="article-tab-pane-template">
    <div class="tab-pane fade" role="tabpanel">
        
        <!-- Metadata Toolbar -->
        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom border-dashed">
            <div class="norma-details small text-muted d-flex gap-3">
                <!-- Details injected via JS -->
            </div>
            <div class="tools d-flex gap-2">
                <button class="btn btn-sm btn-link text-muted" title="Copia testo"><i class="bi bi-clipboard"></i></button>
                <button class="btn btn-sm btn-link text-muted" title="Aggiungi nota"><i class="bi bi-sticky"></i></button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="article-content-wrapper mb-4">
            <textarea class="article-text"></textarea>
        </div>

        <!-- Brocardi & Insights -->
        <div class="brocardi-info bg-body-tertiary rounded-3 p-3 mt-4" style="display:none;">
            <h6 class="d-flex align-items-center gap-2 text-primary mb-3">
                <i class="bi bi-lightbulb-fill"></i> Approfondimenti Giuridici
            </h6>
            <div class="brocardi-content d-flex flex-column gap-3"></div>
        </div>
    </div>
  </template>

  <!-- Modals -->
  
  <!-- Reset Confirmation -->
  <div class="modal fade" id="resetConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body p-4 text-center">
            <div class="mb-3 text-warning"><i class="bi bi-exclamation-circle fs-1"></i></div>
            <h5>Conferma Reset</h5>
            <p class="text-muted">Stai per cancellare tutti i dati inseriti e i tab non salvati. Procedere?</p>
            <div class="d-flex gap-2 justify-content-center mt-4">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger px-4" id="confirmResetButton">Resetta Tutto</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Modal -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg h-100">
        <div class="modal-header border-bottom-0">
            <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-pdf me-2 text-danger"></i>Visualizzatore Documento</h5>
            <div class="d-flex gap-2 ms-auto align-items-center">
                <a id="downloadPdfBtn" class="btn btn-primary btn-sm" href="#" download><i class="bi bi-download me-2"></i>Salva PDF</a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
        </div>
        <div class="modal-body p-0 bg-dark position-relative">
            <div id="pdfProgressContainer" class="position-absolute top-50 start-50 translate-middle w-50 text-center text-white" style="z-index: 10;">
                <p>Caricamento documento...</p>
                <div class="progress" style="height: 5px;">
                    <progress id="pdfProgressBar" value="0" max="100" class="w-100 h-100"></progress>
                </div>
            </div>
            <iframe id="pdfIframe" class="w-100 h-100 border-0" title="PDF Viewer"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
  <script src="/static/script.js?v=2.0" defer></script>
</body>
</html>
