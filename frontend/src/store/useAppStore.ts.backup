import { useStore } from 'zustand/react';
import { createStore } from 'zustand/vanilla';
import { persist } from 'zustand/middleware';
import { immer } from 'zustand/middleware/immer';
import { v4 as uuidv4 } from 'uuid';
import type { AppSettings, Bookmark, Dossier, Annotation, Highlight, NormaVisitata, ArticleData } from '../types';

// Content types for WorkspaceTab
interface NormaBlock {
    type: 'norma';
    id: string;
    norma: any;
    articles: ArticleData[];
    isCollapsed: boolean;
}

interface LooseArticle {
    type: 'loose-article';
    id: string;
    article: ArticleData;
    sourceNorma: any;
}

type TabContent = NormaBlock | LooseArticle;

// Renamed from FloatingPanel to WorkspaceTab
interface WorkspaceTab {
    id: string;
    label: string;
    position: { x: number; y: number };
    size: { width: number; height: number };
    zIndex: number;
    isPinned: boolean;
    isMinimized: boolean;
    content: TabContent[]; // Mixed norme and loose articles
}

interface SearchPanelState {
    isCollapsed: boolean;
    position: { x: number; y: number };
}

interface AppState {
    settings: AppSettings;
    bookmarks: Bookmark[];
    dossiers: Dossier[];
    annotations: Annotation[];
    highlights: Highlight[];
    comparisonArticle: ArticleData | null;

    // UI State
    sidebarVisible: boolean;
    searchPanelState: SearchPanelState;
    workspaceTabs: WorkspaceTab[];
    highestZIndex: number;

    // Actions
    updateSettings: (settings: Partial<AppSettings>) => void;

    // UI Actions
    toggleSidebar: () => void;
    setSidebarVisible: (visible: boolean) => void;
    toggleSearchPanel: () => void;
    setSearchPanelPosition: (position: { x: number; y: number }) => void;

    // Workspace Tab Actions
    addWorkspaceTab: (label: string, norma?: any, articles?: ArticleData[]) => string;
    addNormaToTab: (tabId: string, norma: any, articles: ArticleData[]) => void;
    addLooseArticleToTab: (tabId: string, article: ArticleData, sourceNorma: any) => void;
    updateTab: (id: string, updates: Partial<WorkspaceTab>) => void;
    removeTab: (id: string) => void;
    bringTabToFront: (id: string) => void;
    toggleTabPin: (id: string) => void;
    toggleTabMinimize: (id: string) => void;
    toggleNormaCollapse: (tabId: string, normaId: string) => void;
    setTabLabel: (id: string, label: string) => void;

    // Drag & Drop Actions
    moveNormaBetweenTabs: (normaId: string, sourceTabId: string, targetTabId: string) => void;
    extractArticleFromNorma: (tabId: string, normaId: string, articleId: string) => void;
    moveLooseArticleBetweenTabs: (articleId: string, sourceTabId: string, targetTabId: string) => void;
    removeArticleFromNorma: (tabId: string, normaId: string, articleId: string) => void;
    
    addBookmark: (norma: NormaVisitata, tags?: string[]) => void;
    updateBookmarkTags: (normaKey: string, tags: string[]) => void;
    removeBookmark: (normaKey: string) => void;
    isBookmarked: (normaKey: string) => boolean;
    
    createDossier: (title: string, description?: string) => void;
    deleteDossier: (id: string) => void;
    addToDossier: (dossierId: string, item: any, type: 'norma' | 'note') => void;
    removeFromDossier: (dossierId: string, itemId: string) => void;
    
    addAnnotation: (normaKey: string, articleId: string, text: string) => void;
    removeAnnotation: (id: string) => void;
    
    addHighlight: (normaKey: string, articleId: string, text: string, range: string, color: Highlight['color']) => void;
    removeHighlight: (id: string) => void;
    getHighlights: (normaKey: string, articleId: string) => Highlight[];

    setComparisonArticle: (article: ArticleData) => void;
    clearComparisonArticle: () => void;
}

const DEFAULT_SETTINGS: AppSettings = {
    theme: 'light',
    fontSize: 'medium',
    fontFamily: 'sans',
    focusMode: false,
    splitView: false,
};

// Helper to generate consistent keys for bookmarks
const generateKey = (n: NormaVisitata) => {
    const sanitize = (str: string) => str.replace(/\s+/g, '-').replace(/[^\w-]/g, '').toLowerCase();
    const parts = [n.tipo_atto];
    if (n.numero_atto?.trim()) parts.push(n.numero_atto);
    if (n.data?.trim()) parts.push(n.data);
    if (n.numero_articolo?.trim()) parts.push(n.numero_articolo);
    return parts.map(part => sanitize(part || '')).join('--');
};

const appStore = createStore<AppState>()(
    persist(
        immer((set, get) => ({
            settings: DEFAULT_SETTINGS,
            bookmarks: [],
            dossiers: [],
            annotations: [],
            highlights: [],
            comparisonArticle: null,

            // UI State
            sidebarVisible: true,
            searchPanelState: {
                isCollapsed: false,
                position: { x: window.innerWidth - 420, y: 20 }
            },
            workspaceTabs: [],
            highestZIndex: 100,

            updateSettings: (newSettings) => set((state) => {
                state.settings = { ...state.settings, ...newSettings };
            }),

            // UI Actions
            toggleSidebar: () => set((state) => {
                state.sidebarVisible = !state.sidebarVisible;
            }),

            setSidebarVisible: (visible) => set((state) => {
                state.sidebarVisible = visible;
            }),

            toggleSearchPanel: () => set((state) => {
                state.searchPanelState.isCollapsed = !state.searchPanelState.isCollapsed;
            }),

            setSearchPanelPosition: (position) => set((state) => {
                state.searchPanelState.position = position;
            }),

            // Floating Panel Actions
            addFloatingPanel: (norma, articles, normaKey) => set((state) => {
                const existingPanel = state.floatingPanels.find(p => p.normaKey === normaKey);

                if (existingPanel) {
                    // Merge new articles with existing ones
                    const existingArticleIds = new Set(
                        existingPanel.articles.map(a => a.norma_data.numero_articolo)
                    );

                    // Add only new articles that don't exist yet
                    const newArticles = articles.filter(
                        a => !existingArticleIds.has(a.norma_data.numero_articolo)
                    );

                    if (newArticles.length > 0) {
                        existingPanel.articles = [...existingPanel.articles, ...newArticles];

                        // Sort articles by numero_articolo
                        existingPanel.articles.sort((a, b) => {
                            const numA = parseInt(a.norma_data.numero_articolo) || 0;
                            const numB = parseInt(b.norma_data.numero_articolo) || 0;
                            return numA - numB;
                        });

                        // Set active article to the first new article
                        existingPanel.activeArticleId = newArticles[0].norma_data.numero_articolo;
                    }

                    // Bring to front
                    existingPanel.zIndex = ++state.highestZIndex;
                } else {
                    // Create new panel with cascade positioning
                    const panelCount = state.floatingPanels.length;
                    const cascade = (panelCount % 5) * 40;

                    // Sort initial articles
                    const sortedArticles = [...articles].sort((a, b) => {
                        const numA = parseInt(a.norma_data.numero_articolo) || 0;
                        const numB = parseInt(b.norma_data.numero_articolo) || 0;
                        return numA - numB;
                    });

                    state.floatingPanels.push({
                        id: uuidv4(),
                        normaKey,
                        norma,
                        articles: sortedArticles,
                        position: { x: 100 + cascade, y: 100 + cascade },
                        size: { width: 700, height: 600 },
                        zIndex: ++state.highestZIndex,
                        isMinimized: false,
                        isPinned: false,
                        activeArticleId: sortedArticles[0]?.norma_data?.numero_articolo || null
                    });
                }
            }),

            updateFloatingPanel: (id, updates) => set((state) => {
                const panel = state.floatingPanels.find(p => p.id === id);
                if (panel) {
                    Object.assign(panel, updates);
                }
            }),

            removeFloatingPanel: (id) => set((state) => {
                state.floatingPanels = state.floatingPanels.filter(p => p.id !== id);
            }),

            bringPanelToFront: (id) => set((state) => {
                const panel = state.floatingPanels.find(p => p.id === id);
                if (panel && !panel.isPinned) {
                    panel.zIndex = ++state.highestZIndex;
                }
            }),

            togglePanelPin: (id) => set((state) => {
                const panel = state.floatingPanels.find(p => p.id === id);
                if (panel) {
                    panel.isPinned = !panel.isPinned;
                }
            }),

            togglePanelMinimize: (id) => set((state) => {
                const panel = state.floatingPanels.find(p => p.id === id);
                if (panel) {
                    panel.isMinimized = !panel.isMinimized;
                }
            }),

            setPanelLabel: (id, label) => set((state) => {
                const panel = state.floatingPanels.find(p => p.id === id);
                if (panel) {
                    panel.label = label;
                }
            }),

            popOutArticle: (panelId, articleId) => set((state) => {
                const sourcePanel = state.floatingPanels.find(p => p.id === panelId);
                if (!sourcePanel) return;

                const article = sourcePanel.articles.find(a => a.norma_data.numero_articolo === articleId);
                if (!article) return;

                // Remove article from source panel
                sourcePanel.articles = sourcePanel.articles.filter(
                    a => a.norma_data.numero_articolo !== articleId
                );

                // If source panel is now empty, remove it
                if (sourcePanel.articles.length === 0) {
                    state.floatingPanels = state.floatingPanels.filter(p => p.id !== panelId);
                } else {
                    // Update active article in source panel
                    sourcePanel.activeArticleId = sourcePanel.articles[0]?.norma_data?.numero_articolo || null;
                }

                // Create new panel with just this article
                const panelCount = state.floatingPanels.length;
                const cascade = (panelCount % 5) * 40;

                state.floatingPanels.push({
                    id: uuidv4(),
                    normaKey: `${sourcePanel.normaKey}-art${articleId}`,
                    norma: sourcePanel.norma,
                    articles: [article],
                    position: { x: 140 + cascade, y: 140 + cascade },
                    size: { width: 700, height: 600 },
                    zIndex: ++state.highestZIndex,
                    isMinimized: false,
                    isPinned: false,
                    activeArticleId: articleId,
                    label: `Art. ${articleId}`
                });
            }),

            addBookmark: (norma, tags = []) => set((state) => {
                const key = generateKey(norma);
                if (!state.bookmarks.find(b => b.normaKey === key)) {
                    state.bookmarks.push({
                        id: uuidv4(),
                        normaKey: key,
                        normaData: norma,
                        addedAt: new Date().toISOString(),
                        tags
                    });
                }
            }),

            updateBookmarkTags: (key, tags) => set((state) => {
                const bookmark = state.bookmarks.find(b => b.normaKey === key);
                if (bookmark) {
                    bookmark.tags = tags;
                }
            }),

            removeBookmark: (key) => set((state) => {
                state.bookmarks = state.bookmarks.filter(b => b.normaKey !== key);
            }),

            isBookmarked: (key) => {
                return !!get().bookmarks.find(b => b.normaKey === key);
            },

            createDossier: (title, description) => set((state) => {
                state.dossiers.push({
                    id: uuidv4(),
                    title,
                    description,
                    createdAt: new Date().toISOString(),
                    items: []
                });
            }),

            deleteDossier: (id) => set((state) => {
                state.dossiers = state.dossiers.filter(d => d.id !== id);
            }),

            addToDossier: (dossierId, itemData, type) => set((state) => {
                const dossier = state.dossiers.find(d => d.id === dossierId);
                if (dossier) {
                    dossier.items.push({
                        id: uuidv4(),
                        type,
                        data: itemData,
                        addedAt: new Date().toISOString()
                    });
                }
            }),

            removeFromDossier: (dossierId, itemId) => set((state) => {
                const dossier = state.dossiers.find(d => d.id === dossierId);
                if (dossier) {
                    dossier.items = dossier.items.filter(i => i.id !== itemId);
                }
            }),

            addAnnotation: (normaKey, articleId, text) => set((state) => {
                state.annotations.push({
                    id: uuidv4(),
                    normaKey,
                    articleId,
                    text,
                    createdAt: new Date().toISOString()
                });
            }),

            removeAnnotation: (id) => set((state) => {
                state.annotations = state.annotations.filter(a => a.id !== id);
            }),

            addHighlight: (normaKey, articleId, text, range, color) => set((state) => {
                 state.highlights.push({
                     id: uuidv4(),
                     normaKey,
                     articleId,
                     text,
                     rangeSerialized: range,
                     color
                 });
            }),

            removeHighlight: (id) => set((state) => {
                state.highlights = state.highlights.filter(h => h.id !== id);
            }),

            getHighlights: (normaKey, articleId) => {
                return get().highlights.filter(h => h.normaKey === normaKey && h.articleId === articleId);
            },

            setComparisonArticle: (article) => set((state) => {
                state.comparisonArticle = article;
            }),

            clearComparisonArticle: () => set((state) => {
                state.comparisonArticle = null;
            })
        })),
        {
            name: 'visualex-storage',
        }
    )
);

export function useAppStore(): AppState;
export function useAppStore<T>(selector: (state: AppState) => T): T;
export function useAppStore<T>(selector?: (state: AppState) => T) {
    if (selector) {
        return useStore(appStore, selector);
    }
    return useStore(appStore);
}

// Export types
export type { WorkspaceTab, NormaBlock, LooseArticle, TabContent, SearchPanelState };

